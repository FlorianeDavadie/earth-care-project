<h1>Missions</h1>

<strong><p> Hello to all concerned and conscious people !</p> </strong>
<%= link_to "New mission", new_mission_path %>

<% content_for :scripts do %>
  <script src='https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js'></script>
  <script>
    const mapboxToken = 'pk.eyJ1IjoibWFyaWVsbGV0YXlyaSIsImEiOiJjbGYwdnpoZWEwMmt0M3pwbjA1czRydHFkIn0.onllMdPD3t7d-iGI91qE7Q';
    mapboxgl.accessToken = mapboxToken;

    const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v11',
    center: [2.3522, 48.8566],
    zoom: 12,
    });
    <% @missions.each do |mission| %>
    const geocoder = new MapboxGeocoder({
    accessToken: mapboxToken,
    mapboxgl: mapboxgl,
  });
    geocoder.setQuery('<%= mission.address %>');
    geocoder.on('result', function(result) {
    const marker = new mapboxgl.Marker()
      .setLngLat(result.result.geometry.coordinates)
      .addTo(map);
    const popup = new mapboxgl.Popup()
    .setHTML(`<h4><%= mission.title %></h4><p><%= mission.description %></p><p><strong>Address:</strong> <%= mission.address %></p>`);
    marker.setPopup(popup);
  });
  map.addControl(geocoder);
  <% end %>

  </script>
<% end %>

<div id="map" style="height: 400px;"></div>

<% content_for :scripts do %>
  <script async defer src="https://api.mapbox.com/mapbox-gl-js/v2.6.1/mapbox-gl.js"></script>
<% end %>

<%# itÃ© sur tte les missions. pr chaque mission, objet geocoder utulusÃ© pr gÃ©ocod l'adresse de la mission.
on utilise adresse de la mission stockÃ©e dans mission.adress.
result renvoyÃ© dans le callback qui prend 2 args (status et results)
si status ok, on crÃ©er un marker  pour ajouter un marqueur sur la carte Ã  l'emplacement de la missio
InfoWindow de Google Maps qui est utilisÃ© pour afficher des informations supplÃ©mentaires sur la mission lorsque l'utilisateur clique sur le marque %>

<% @missions.each do |mission| %>
  <div class="mission">

    <%= image_tag mission.photo_url %>

    <h3><%= mission.title %></h3>
    <p><%= mission.description %></p>
    <p><strong>Location:</strong><%= mission.location %></p>
    <p><strong>Address:</strong><%= mission.address %></p>

    <% start_date = Date.today + rand(30) %>
    <% end_date = [start_date + rand(4), Date.today + 30].min %>
    <p><strong>Date:</strong> <%= start_date.strftime('%d/%m/%Y') %> - <%= end_date.strftime('%d/%m/%Y') %></p>
    <p><strong>Time:</strong> <%= Time.new(2000, 1, 1, rand(5..21), [0, 15, 30, 45].sample).strftime('%H:%M') %> <strong>sharp</strong><%="ðŸ‘Œ".html_safe %></p>
    <p><strong>Duration:</strong> <%=mission.duration = rand(1..5) %> hours per day</p>
    <p><strong>Dess code:</strong> <%= mission.dess_code %></p>
    <p><strong>Reward:</strong> <%= mission.reward %> points</p>
    <p><strong>Rating:</strong> <%= mission.rating %></p>
    <%= link_to "Book your mission",  new_mission_booking_path(mission) %>

  </div>
<% end %>


  <%# <%= link_to "CHECK THE MISSION", mission_path(mission) %>

<%# pk.eyJ1IjoidGhlb2JvbmRheiIsImEiOiJjazc0anVmMjUwOHZ0M2VwYTRlcGs2dnZjIn0.byLisvWA9__hIZ5FBFybNw %>
